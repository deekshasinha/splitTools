<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Using 'splitTools' • splitTools</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Using 'splitTools'">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">splitTools</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.2.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/splitTools.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/mayer79/splitTools">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Using ‘splitTools’</h1>
                        <h4 class="author">Michael Mayer</h4>
            
            <h4 class="date">2020-01-24</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/mayer79/splitTools/blob/master/../../vignettes/splitTools.Rmd"><code>../../vignettes/splitTools.Rmd</code></a></small>
      <div class="hidden name"><code>splitTools.Rmd</code></div>

    </div>

    
    
<div id="introduction" class="section level2">
<h2 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h2>
<p><code>splitTools</code> is a fast, lightweight toolkit for data splitting.</p>
<p>Its two main functions <code>partition</code> and <code>create_folds</code> support</p>
<ul>
<li><p>data partitioning (e.g. into training, validation and test),</p></li>
<li><p>creating folds for cross-validation,</p></li>
<li><p>creating <em>repeated</em> folds for cross-validation,</p></li>
<li><p>stratified splitting (e.g. for stratified cross-validation),</p></li>
<li><p>grouped splitting (e.g. for group-k-fold cross-validation) as well as</p></li>
<li><p>blocked splitting (if the sequential order of the data should be retained).</p></li>
</ul>
<p>The function <code>create_timefolds</code> does time-series splitting where the out-of-sample data follows the (growing) in-sample data.</p>
<p>We will now illustrate how to use <code>splitTools</code> in a typical modelling workflow.</p>
</div>
<div id="data-partitioning" class="section level2">
<h2 class="hasAnchor">
<a href="#data-partitioning" class="anchor"></a>Data partitioning</h2>
<p>We will go through the following three steps:</p>
<ol style="list-style-type: decimal">
<li><p>Split the data set <code>iris</code> into 60% training data, 20% validation and 20% test, stratified by the variable <code>Sepal.Length</code>. Since it is numeric, stratification is done internally by quantile binning.</p></li>
<li><p>We then tune the parameter <code>mtry</code> of a random forest to predict <code>Sepal.Length</code> as good as possible by the other variables. We do this on the validation data.</p></li>
<li><p>After selecting the best <code>mtry</code>, we challenge the final model on the remaining test data set.</p></li>
</ol>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(splitTools)</span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(ranger)</span>
<span id="cb1-3"><a href="#cb1-3"></a></span>
<span id="cb1-4"><a href="#cb1-4"></a><span class="co"># Split data into partitions</span></span>
<span id="cb1-5"><a href="#cb1-5"></a><span class="kw"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="dv">3451</span>)</span>
<span id="cb1-6"><a href="#cb1-6"></a>inds &lt;-<span class="st"> </span><span class="kw"><a href="../reference/partition.html">partition</a></span>(iris<span class="op">$</span>Sepal.Length, <span class="dt">p =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dt">train =</span> <span class="fl">0.6</span>, <span class="dt">valid =</span> <span class="fl">0.2</span>, <span class="dt">test =</span> <span class="fl">0.2</span>))</span>
<span id="cb1-7"><a href="#cb1-7"></a><span class="kw"><a href="https://rdrr.io/r/utils/str.html">str</a></span>(inds)</span>
<span id="cb1-8"><a href="#cb1-8"></a><span class="co">#&gt; List of 3</span></span>
<span id="cb1-9"><a href="#cb1-9"></a><span class="co">#&gt;  $ train: int [1:81] 2 3 6 7 8 10 11 18 19 20 ...</span></span>
<span id="cb1-10"><a href="#cb1-10"></a><span class="co">#&gt;  $ valid: int [1:34] 1 12 14 15 27 34 36 38 42 48 ...</span></span>
<span id="cb1-11"><a href="#cb1-11"></a><span class="co">#&gt;  $ test : int [1:35] 4 5 9 13 16 17 25 39 41 45 ...</span></span>
<span id="cb1-12"><a href="#cb1-12"></a></span>
<span id="cb1-13"><a href="#cb1-13"></a>train &lt;-<span class="st"> </span>iris[inds<span class="op">$</span>train, ]</span>
<span id="cb1-14"><a href="#cb1-14"></a>valid &lt;-<span class="st"> </span>iris[inds<span class="op">$</span>valid, ]</span>
<span id="cb1-15"><a href="#cb1-15"></a>test &lt;-<span class="st"> </span>iris[inds<span class="op">$</span>test, ]</span>
<span id="cb1-16"><a href="#cb1-16"></a></span>
<span id="cb1-17"><a href="#cb1-17"></a><span class="co"># Root-mean-squared error function used to evaluate results</span></span>
<span id="cb1-18"><a href="#cb1-18"></a>rmse &lt;-<span class="st"> </span><span class="cf">function</span>(y, pred) {</span>
<span id="cb1-19"><a href="#cb1-19"></a>  <span class="kw"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>((y <span class="op">-</span><span class="st"> </span>pred)<span class="op">^</span><span class="dv">2</span>))</span>
<span id="cb1-20"><a href="#cb1-20"></a>}</span>
<span id="cb1-21"><a href="#cb1-21"></a></span>
<span id="cb1-22"><a href="#cb1-22"></a><span class="co"># Tune mtry on validation data</span></span>
<span id="cb1-23"><a href="#cb1-23"></a>valid_mtry &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span>(train) <span class="op">-</span><span class="st"> </span><span class="dv">1</span>)</span>
<span id="cb1-24"><a href="#cb1-24"></a></span>
<span id="cb1-25"><a href="#cb1-25"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="kw"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span>(valid_mtry)) {</span>
<span id="cb1-26"><a href="#cb1-26"></a>  fit &lt;-<span class="st"> </span><span class="kw">ranger</span>(Sepal.Length <span class="op">~</span><span class="st"> </span>., <span class="dt">data =</span> train, <span class="dt">mtry =</span> i)</span>
<span id="cb1-27"><a href="#cb1-27"></a>  valid_mtry[i] &lt;-<span class="st"> </span><span class="kw">rmse</span>(valid<span class="op">$</span>Sepal.Length, <span class="kw"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(fit, valid)<span class="op">$</span>predictions)</span>
<span id="cb1-28"><a href="#cb1-28"></a>}</span>
<span id="cb1-29"><a href="#cb1-29"></a></span>
<span id="cb1-30"><a href="#cb1-30"></a>valid_mtry</span>
<span id="cb1-31"><a href="#cb1-31"></a><span class="co">#&gt; [1] 0.3809234 0.3242173 0.3208119 0.3241518</span></span>
<span id="cb1-32"><a href="#cb1-32"></a>(best_mtry &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/which.min.html">which.min</a></span>(valid_mtry))</span>
<span id="cb1-33"><a href="#cb1-33"></a><span class="co">#&gt; [1] 3</span></span>
<span id="cb1-34"><a href="#cb1-34"></a></span>
<span id="cb1-35"><a href="#cb1-35"></a><span class="co"># Fit and test final model</span></span>
<span id="cb1-36"><a href="#cb1-36"></a>final_fit &lt;-<span class="st"> </span><span class="kw">ranger</span>(Sepal.Length <span class="op">~</span><span class="st"> </span>., <span class="dt">data =</span> train, <span class="dt">mtry =</span> best_mtry)</span>
<span id="cb1-37"><a href="#cb1-37"></a><span class="kw">rmse</span>(test<span class="op">$</span>Sepal.Length, <span class="kw"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(final_fit, test)<span class="op">$</span>predictions)</span>
<span id="cb1-38"><a href="#cb1-38"></a><span class="co">#&gt; [1] 0.3480947</span></span></code></pre></div>
</div>
<div id="cross-validation" class="section level2">
<h2 class="hasAnchor">
<a href="#cross-validation" class="anchor"></a>Cross-validation</h2>
<p>Since our data set consists of only 150 rows, investing 20% of observations for validation is neither robust nor data efficient. Let’s modify the modelling strategy by replacing simple validation by five-fold cross-validation, again using stratification on the response variable.</p>
<ol style="list-style-type: decimal">
<li><p>Split the data set <code>iris</code> into 80% training data and 20% test, stratified by the variable <code>Sepal.Length</code>.</p></li>
<li><p>Use stratified five-fold cross-validation to tune the parameter <code>mtry</code>. We do this on the validation data.</p></li>
<li><p>After selecting the best <code>mtry</code> by this simple “GridSearchCV”, we challenge the final model on the test data set.</p></li>
</ol>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a><span class="co"># Split into training and test</span></span>
<span id="cb2-2"><a href="#cb2-2"></a>inds &lt;-<span class="st"> </span><span class="kw"><a href="../reference/partition.html">partition</a></span>(iris<span class="op">$</span>Sepal.Length, <span class="dt">p =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dt">train =</span> <span class="fl">0.8</span>, <span class="dt">test =</span> <span class="fl">0.2</span>))</span>
<span id="cb2-3"><a href="#cb2-3"></a></span>
<span id="cb2-4"><a href="#cb2-4"></a>train &lt;-<span class="st"> </span>iris[inds<span class="op">$</span>train, ]</span>
<span id="cb2-5"><a href="#cb2-5"></a>test &lt;-<span class="st"> </span>iris[inds<span class="op">$</span>test, ]</span>
<span id="cb2-6"><a href="#cb2-6"></a></span>
<span id="cb2-7"><a href="#cb2-7"></a><span class="co"># Get stratified cross-validation fold indices</span></span>
<span id="cb2-8"><a href="#cb2-8"></a>folds &lt;-<span class="st"> </span><span class="kw"><a href="../reference/create_folds.html">create_folds</a></span>(train<span class="op">$</span>Sepal.Length, <span class="dt">k =</span> <span class="dv">5</span>)</span>
<span id="cb2-9"><a href="#cb2-9"></a></span>
<span id="cb2-10"><a href="#cb2-10"></a><span class="co"># Tune mtry by GridSearchCV</span></span>
<span id="cb2-11"><a href="#cb2-11"></a>valid_mtry &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span>(train) <span class="op">-</span><span class="st"> </span><span class="dv">1</span>)</span>
<span id="cb2-12"><a href="#cb2-12"></a></span>
<span id="cb2-13"><a href="#cb2-13"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="kw"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span>(valid_mtry)) {</span>
<span id="cb2-14"><a href="#cb2-14"></a>  cv_mtry &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span>()</span>
<span id="cb2-15"><a href="#cb2-15"></a>  <span class="cf">for</span> (fold <span class="cf">in</span> folds) {</span>
<span id="cb2-16"><a href="#cb2-16"></a>    fit &lt;-<span class="st"> </span><span class="kw">ranger</span>(Sepal.Length <span class="op">~</span><span class="st"> </span>., <span class="dt">data =</span> train[fold, ], <span class="dt">mtry =</span> i)</span>
<span id="cb2-17"><a href="#cb2-17"></a>    cv_mtry &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(cv_mtry, </span>
<span id="cb2-18"><a href="#cb2-18"></a>                 <span class="kw">rmse</span>(train[<span class="op">-</span>fold, <span class="st">"Sepal.Length"</span>], <span class="kw"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(fit, train[<span class="op">-</span>fold, ])<span class="op">$</span>predictions))</span>
<span id="cb2-19"><a href="#cb2-19"></a>  }</span>
<span id="cb2-20"><a href="#cb2-20"></a>  valid_mtry[i] &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(cv_mtry)</span>
<span id="cb2-21"><a href="#cb2-21"></a>}</span>
<span id="cb2-22"><a href="#cb2-22"></a></span>
<span id="cb2-23"><a href="#cb2-23"></a><span class="co"># Result of cross-validation</span></span>
<span id="cb2-24"><a href="#cb2-24"></a>valid_mtry</span>
<span id="cb2-25"><a href="#cb2-25"></a><span class="co">#&gt; [1] 0.3870915 0.3460605 0.3337763 0.3302831</span></span>
<span id="cb2-26"><a href="#cb2-26"></a>(best_mtry &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/which.min.html">which.min</a></span>(valid_mtry))</span>
<span id="cb2-27"><a href="#cb2-27"></a><span class="co">#&gt; [1] 4</span></span>
<span id="cb2-28"><a href="#cb2-28"></a></span>
<span id="cb2-29"><a href="#cb2-29"></a><span class="co"># Use optimal mtry to make model</span></span>
<span id="cb2-30"><a href="#cb2-30"></a>final_fit &lt;-<span class="st"> </span><span class="kw">ranger</span>(Sepal.Length <span class="op">~</span><span class="st"> </span>., <span class="dt">data =</span> train, <span class="dt">mtry =</span> best_mtry)</span>
<span id="cb2-31"><a href="#cb2-31"></a><span class="kw">rmse</span>(test<span class="op">$</span>Sepal.Length, <span class="kw"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(final_fit, test)<span class="op">$</span>predictions)</span>
<span id="cb2-32"><a href="#cb2-32"></a><span class="co">#&gt; [1] 0.2970876</span></span></code></pre></div>
</div>
<div id="repeated-cross-validation" class="section level2">
<h2 class="hasAnchor">
<a href="#repeated-cross-validation" class="anchor"></a>Repeated cross-validation</h2>
<p>If feasible, repeated cross-validation is recommended in order to reduce uncertainty in decisions. The process is the same as above. Instead of getting five performance values per fold, we get five times the number of repetitions (here, three).</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a><span class="co"># We start by making repeated, stratified cross-validation folds</span></span>
<span id="cb3-2"><a href="#cb3-2"></a>folds &lt;-<span class="st"> </span><span class="kw"><a href="../reference/create_folds.html">create_folds</a></span>(train<span class="op">$</span>Sepal.Length, <span class="dt">k =</span> <span class="dv">5</span>, <span class="dt">m_rep =</span> <span class="dv">3</span>)</span>
<span id="cb3-3"><a href="#cb3-3"></a><span class="kw"><a href="https://rdrr.io/r/base/length.html">length</a></span>(folds)</span>
<span id="cb3-4"><a href="#cb3-4"></a><span class="co">#&gt; [1] 15</span></span>
<span id="cb3-5"><a href="#cb3-5"></a></span>
<span id="cb3-6"><a href="#cb3-6"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="kw"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span>(valid_mtry)) {</span>
<span id="cb3-7"><a href="#cb3-7"></a>  cv_mtry &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span>()</span>
<span id="cb3-8"><a href="#cb3-8"></a>  <span class="cf">for</span> (fold <span class="cf">in</span> folds) {</span>
<span id="cb3-9"><a href="#cb3-9"></a>    fit &lt;-<span class="st"> </span><span class="kw">ranger</span>(Sepal.Length <span class="op">~</span><span class="st"> </span>., <span class="dt">data =</span> train[fold, ], <span class="dt">mtry =</span> i)</span>
<span id="cb3-10"><a href="#cb3-10"></a>    cv_mtry &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(cv_mtry, </span>
<span id="cb3-11"><a href="#cb3-11"></a>                 <span class="kw">rmse</span>(train[<span class="op">-</span>fold, <span class="st">"Sepal.Length"</span>], <span class="kw"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(fit, train[<span class="op">-</span>fold, ])<span class="op">$</span>predictions))</span>
<span id="cb3-12"><a href="#cb3-12"></a>  }</span>
<span id="cb3-13"><a href="#cb3-13"></a>  valid_mtry[i] &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(cv_mtry)</span>
<span id="cb3-14"><a href="#cb3-14"></a>}</span>
<span id="cb3-15"><a href="#cb3-15"></a></span>
<span id="cb3-16"><a href="#cb3-16"></a><span class="co"># Result of cross-validation</span></span>
<span id="cb3-17"><a href="#cb3-17"></a>valid_mtry</span>
<span id="cb3-18"><a href="#cb3-18"></a><span class="co">#&gt; [1] 0.3934294 0.3544207 0.3422013 0.3393454</span></span>
<span id="cb3-19"><a href="#cb3-19"></a>(best_mtry &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/which.min.html">which.min</a></span>(valid_mtry))</span>
<span id="cb3-20"><a href="#cb3-20"></a><span class="co">#&gt; [1] 4</span></span>
<span id="cb3-21"><a href="#cb3-21"></a></span>
<span id="cb3-22"><a href="#cb3-22"></a><span class="co"># Use optimal mtry to make model</span></span>
<span id="cb3-23"><a href="#cb3-23"></a>final_fit &lt;-<span class="st"> </span><span class="kw">ranger</span>(Sepal.Length <span class="op">~</span><span class="st"> </span>., <span class="dt">data =</span> train, <span class="dt">mtry =</span> best_mtry)</span>
<span id="cb3-24"><a href="#cb3-24"></a><span class="kw">rmse</span>(test<span class="op">$</span>Sepal.Length, <span class="kw"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(final_fit, test)<span class="op">$</span>predictions)</span>
<span id="cb3-25"><a href="#cb3-25"></a><span class="co">#&gt; [1] 0.2937055</span></span></code></pre></div>
</div>
<div id="time-series-cross-validation-and-block-partitioning" class="section level2">
<h2 class="hasAnchor">
<a href="#time-series-cross-validation-and-block-partitioning" class="anchor"></a>Time-series cross-validation and block partitioning</h2>
<p>When modelling time series, usual cross-validation destroys the sequential nature of the data. This can be avoided by the following modification of k-fold cross-validation:</p>
<p>The data is first split into <span class="math inline">\(k+1\)</span> blocks <span class="math inline">\(B_1, ..., B_{k+1}\)</span>, in sequential order. The following data sets are used in cross-validation:</p>
<ul>
<li><p>First fold: <span class="math inline">\(B_1\)</span> is used for training, <span class="math inline">\(B_2\)</span> for evaluation.</p></li>
<li><p>Second fold: <span class="math inline">\(\{B_1, B_2\}\)</span> is used for training, <span class="math inline">\(B_3\)</span> for evaluation.</p></li>
<li><p>…</p></li>
<li><p><span class="math inline">\(k\)</span>-th fold: <span class="math inline">\(\{B_1, ..., B_k\}\)</span> is used for training, <span class="math inline">\(B_{k+1}\)</span> for evaluation.</p></li>
</ul>
<p>This schema makes sure that the evaluation data set always follows the training data. Note that the training data grows over the whole process linearly.</p>
<p>In order to have a final evaluation of the optimized model, typically an initial blocked split into sequential training and testing data is done.</p>
<div id="example" class="section level3">
<h3 class="hasAnchor">
<a href="#example" class="anchor"></a>Example</h3>
<p>We first create a time series and derive lagged features for training. Then, again, we optimize <code>mtry</code> of a random forest by time-series cross-validation. We evaluate the optimized model on the last 10% of the time series.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a><span class="co"># Create data</span></span>
<span id="cb4-2"><a href="#cb4-2"></a><span class="kw"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="dv">452</span>)</span>
<span id="cb4-3"><a href="#cb4-3"></a>n &lt;-<span class="st"> </span><span class="dv">1000</span></span>
<span id="cb4-4"><a href="#cb4-4"></a>t &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="dv">0</span>, <span class="dv">2</span> <span class="op">*</span><span class="st"> </span>pi, <span class="dt">length.out =</span> n)</span>
<span id="cb4-5"><a href="#cb4-5"></a>y &lt;-<span class="st"> </span><span class="fl">0.2</span> <span class="op">*</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Trig.html">sin</a></span>(t) <span class="op">-</span><span class="st"> </span><span class="fl">0.1</span> <span class="op">*</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Trig.html">cos</a></span>(t) <span class="op">+</span><span class="st"> </span><span class="fl">0.2</span> <span class="op">*</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span>(n)</span>
<span id="cb4-6"><a href="#cb4-6"></a><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(y <span class="op">~</span><span class="st"> </span>t, <span class="dt">pch =</span> <span class="st">"."</span>, <span class="dt">cex =</span> <span class="dv">2</span>)</span></code></pre></div>
<p><img src="splitTools_files/figure-html/unnamed-chunk-5-1.png" width="672"></p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a></span>
<span id="cb5-2"><a href="#cb5-2"></a><span class="co"># Helper function</span></span>
<span id="cb5-3"><a href="#cb5-3"></a>Lag &lt;-<span class="st"> </span><span class="cf">function</span>(z, <span class="dt">k =</span> <span class="dv">1</span>) {</span>
<span id="cb5-4"><a href="#cb5-4"></a>  <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(z[<span class="op">-</span><span class="kw"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span>(k)], <span class="kw"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="ot">NA</span>, k))</span>
<span id="cb5-5"><a href="#cb5-5"></a>}</span>
<span id="cb5-6"><a href="#cb5-6"></a><span class="kw">Lag</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">4</span>, <span class="dt">k =</span> <span class="dv">1</span>)</span>
<span id="cb5-7"><a href="#cb5-7"></a><span class="co">#&gt; [1]  2  3  4 NA</span></span>
<span id="cb5-8"><a href="#cb5-8"></a></span>
<span id="cb5-9"><a href="#cb5-9"></a><span class="co"># Add lagged features</span></span>
<span id="cb5-10"><a href="#cb5-10"></a>dat &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(y, </span>
<span id="cb5-11"><a href="#cb5-11"></a>                  <span class="dt">lag1 =</span> <span class="kw">Lag</span>(y), </span>
<span id="cb5-12"><a href="#cb5-12"></a>                  <span class="dt">lag2 =</span> <span class="kw">Lag</span>(y, <span class="dt">k =</span> <span class="dv">2</span>), </span>
<span id="cb5-13"><a href="#cb5-13"></a>                  <span class="dt">lag3 =</span> <span class="kw">Lag</span>(y, <span class="dt">k =</span> <span class="dv">3</span>))</span>
<span id="cb5-14"><a href="#cb5-14"></a>dat &lt;-<span class="st"> </span>dat[<span class="kw"><a href="https://rdrr.io/r/stats/complete.cases.html">complete.cases</a></span>(dat), ]</span>
<span id="cb5-15"><a href="#cb5-15"></a><span class="kw"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(dat)</span>
<span id="cb5-16"><a href="#cb5-16"></a><span class="co">#&gt;              y         lag1         lag2        lag3</span></span>
<span id="cb5-17"><a href="#cb5-17"></a><span class="co">#&gt; 1 -0.085447174  0.075314649 -0.007841658  0.10081516</span></span>
<span id="cb5-18"><a href="#cb5-18"></a><span class="co">#&gt; 2  0.075314649 -0.007841658  0.100815165  0.09635395</span></span>
<span id="cb5-19"><a href="#cb5-19"></a><span class="co">#&gt; 3 -0.007841658  0.100815165  0.096353945 -0.06476294</span></span>
<span id="cb5-20"><a href="#cb5-20"></a><span class="co">#&gt; 4  0.100815165  0.096353945 -0.064762935  0.10474890</span></span>
<span id="cb5-21"><a href="#cb5-21"></a><span class="co">#&gt; 5  0.096353945 -0.064762935  0.104748904  0.07030228</span></span>
<span id="cb5-22"><a href="#cb5-22"></a><span class="co">#&gt; 6 -0.064762935  0.104748904  0.070302283  0.01085425</span></span>
<span id="cb5-23"><a href="#cb5-23"></a><span class="kw"><a href="https://rdrr.io/r/stats/cor.html">cor</a></span>(dat)</span>
<span id="cb5-24"><a href="#cb5-24"></a><span class="co">#&gt;              y      lag1      lag2      lag3</span></span>
<span id="cb5-25"><a href="#cb5-25"></a><span class="co">#&gt; y    1.0000000 0.8789100 0.8858208 0.8840929</span></span>
<span id="cb5-26"><a href="#cb5-26"></a><span class="co">#&gt; lag1 0.8789100 1.0000000 0.8791226 0.8858995</span></span>
<span id="cb5-27"><a href="#cb5-27"></a><span class="co">#&gt; lag2 0.8858208 0.8791226 1.0000000 0.8791388</span></span>
<span id="cb5-28"><a href="#cb5-28"></a><span class="co">#&gt; lag3 0.8840929 0.8858995 0.8791388 1.0000000</span></span>
<span id="cb5-29"><a href="#cb5-29"></a></span>
<span id="cb5-30"><a href="#cb5-30"></a><span class="co"># Block partitioning</span></span>
<span id="cb5-31"><a href="#cb5-31"></a>inds &lt;-<span class="st"> </span><span class="kw"><a href="../reference/partition.html">partition</a></span>(dat<span class="op">$</span>y, <span class="dt">p =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dt">train =</span> <span class="fl">0.9</span>, <span class="dt">test =</span> <span class="fl">0.1</span>), <span class="dt">type =</span> <span class="st">"blocked"</span>)</span>
<span id="cb5-32"><a href="#cb5-32"></a><span class="kw"><a href="https://rdrr.io/r/utils/str.html">str</a></span>(inds)</span>
<span id="cb5-33"><a href="#cb5-33"></a><span class="co">#&gt; List of 2</span></span>
<span id="cb5-34"><a href="#cb5-34"></a><span class="co">#&gt;  $ train: int [1:898] 1 2 3 4 5 6 7 8 9 10 ...</span></span>
<span id="cb5-35"><a href="#cb5-35"></a><span class="co">#&gt;  $ test : int [1:99] 899 900 901 902 903 904 905 906 907 908 ...</span></span>
<span id="cb5-36"><a href="#cb5-36"></a></span>
<span id="cb5-37"><a href="#cb5-37"></a>train &lt;-<span class="st"> </span>dat[inds<span class="op">$</span>train, ]</span>
<span id="cb5-38"><a href="#cb5-38"></a>test &lt;-<span class="st"> </span>dat[inds<span class="op">$</span>test, ]</span>
<span id="cb5-39"><a href="#cb5-39"></a></span>
<span id="cb5-40"><a href="#cb5-40"></a><span class="co"># Get time series folds</span></span>
<span id="cb5-41"><a href="#cb5-41"></a>folds &lt;-<span class="st"> </span><span class="kw"><a href="../reference/create_timefolds.html">create_timefolds</a></span>(train<span class="op">$</span>y, <span class="dt">k =</span> <span class="dv">5</span>)</span>
<span id="cb5-42"><a href="#cb5-42"></a><span class="kw"><a href="https://rdrr.io/r/utils/str.html">str</a></span>(folds)</span>
<span id="cb5-43"><a href="#cb5-43"></a><span class="co">#&gt; List of 5</span></span>
<span id="cb5-44"><a href="#cb5-44"></a><span class="co">#&gt;  $ Fold1:List of 2</span></span>
<span id="cb5-45"><a href="#cb5-45"></a><span class="co">#&gt;   ..$ insample : int [1:150] 1 2 3 4 5 6 7 8 9 10 ...</span></span>
<span id="cb5-46"><a href="#cb5-46"></a><span class="co">#&gt;   ..$ outsample: int [1:150] 151 152 153 154 155 156 157 158 159 160 ...</span></span>
<span id="cb5-47"><a href="#cb5-47"></a><span class="co">#&gt;  $ Fold2:List of 2</span></span>
<span id="cb5-48"><a href="#cb5-48"></a><span class="co">#&gt;   ..$ insample : int [1:300] 1 2 3 4 5 6 7 8 9 10 ...</span></span>
<span id="cb5-49"><a href="#cb5-49"></a><span class="co">#&gt;   ..$ outsample: int [1:150] 301 302 303 304 305 306 307 308 309 310 ...</span></span>
<span id="cb5-50"><a href="#cb5-50"></a><span class="co">#&gt;  $ Fold3:List of 2</span></span>
<span id="cb5-51"><a href="#cb5-51"></a><span class="co">#&gt;   ..$ insample : int [1:450] 1 2 3 4 5 6 7 8 9 10 ...</span></span>
<span id="cb5-52"><a href="#cb5-52"></a><span class="co">#&gt;   ..$ outsample: int [1:150] 451 452 453 454 455 456 457 458 459 460 ...</span></span>
<span id="cb5-53"><a href="#cb5-53"></a><span class="co">#&gt;  $ Fold4:List of 2</span></span>
<span id="cb5-54"><a href="#cb5-54"></a><span class="co">#&gt;   ..$ insample : int [1:600] 1 2 3 4 5 6 7 8 9 10 ...</span></span>
<span id="cb5-55"><a href="#cb5-55"></a><span class="co">#&gt;   ..$ outsample: int [1:150] 601 602 603 604 605 606 607 608 609 610 ...</span></span>
<span id="cb5-56"><a href="#cb5-56"></a><span class="co">#&gt;  $ Fold5:List of 2</span></span>
<span id="cb5-57"><a href="#cb5-57"></a><span class="co">#&gt;   ..$ insample : int [1:750] 1 2 3 4 5 6 7 8 9 10 ...</span></span>
<span id="cb5-58"><a href="#cb5-58"></a><span class="co">#&gt;   ..$ outsample: int [1:148] 751 752 753 754 755 756 757 758 759 760 ...</span></span>
<span id="cb5-59"><a href="#cb5-59"></a></span>
<span id="cb5-60"><a href="#cb5-60"></a><span class="co"># Tune mtry by GridSearchCV</span></span>
<span id="cb5-61"><a href="#cb5-61"></a>valid_mtry &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span>(train) <span class="op">-</span><span class="st"> </span><span class="dv">1</span>)</span>
<span id="cb5-62"><a href="#cb5-62"></a></span>
<span id="cb5-63"><a href="#cb5-63"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="kw"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span>(valid_mtry)) {</span>
<span id="cb5-64"><a href="#cb5-64"></a>  cv_mtry &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span>()</span>
<span id="cb5-65"><a href="#cb5-65"></a>  <span class="cf">for</span> (fold <span class="cf">in</span> folds) {</span>
<span id="cb5-66"><a href="#cb5-66"></a>    fit &lt;-<span class="st"> </span><span class="kw">ranger</span>(y <span class="op">~</span><span class="st"> </span>., <span class="dt">data =</span> train[fold<span class="op">$</span>insample, ], <span class="dt">mtry =</span> i)</span>
<span id="cb5-67"><a href="#cb5-67"></a>    cv_mtry &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(cv_mtry, </span>
<span id="cb5-68"><a href="#cb5-68"></a>                 <span class="kw">rmse</span>(train[fold<span class="op">$</span>outsample, <span class="st">"y"</span>], </span>
<span id="cb5-69"><a href="#cb5-69"></a>                      <span class="kw"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(fit, train[fold<span class="op">$</span>outsample, ])<span class="op">$</span>predictions))</span>
<span id="cb5-70"><a href="#cb5-70"></a>  }</span>
<span id="cb5-71"><a href="#cb5-71"></a>  valid_mtry[i] &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(cv_mtry)</span>
<span id="cb5-72"><a href="#cb5-72"></a>}</span>
<span id="cb5-73"><a href="#cb5-73"></a></span>
<span id="cb5-74"><a href="#cb5-74"></a><span class="co"># Result of cross-validation</span></span>
<span id="cb5-75"><a href="#cb5-75"></a>valid_mtry</span>
<span id="cb5-76"><a href="#cb5-76"></a><span class="co">#&gt; [1] 0.08227426 0.08188822 0.08230784</span></span>
<span id="cb5-77"><a href="#cb5-77"></a>(best_mtry &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/which.min.html">which.min</a></span>(valid_mtry))</span>
<span id="cb5-78"><a href="#cb5-78"></a><span class="co">#&gt; [1] 2</span></span>
<span id="cb5-79"><a href="#cb5-79"></a></span>
<span id="cb5-80"><a href="#cb5-80"></a><span class="co"># Use optimal mtry to make model and evaluate on future test data</span></span>
<span id="cb5-81"><a href="#cb5-81"></a>final_fit &lt;-<span class="st"> </span><span class="kw">ranger</span>(y <span class="op">~</span><span class="st"> </span>., <span class="dt">data =</span> train, <span class="dt">mtry =</span> best_mtry)</span>
<span id="cb5-82"><a href="#cb5-82"></a>test_pred &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(final_fit, test)<span class="op">$</span>predictions</span>
<span id="cb5-83"><a href="#cb5-83"></a><span class="kw">rmse</span>(test<span class="op">$</span>y, test_pred)</span>
<span id="cb5-84"><a href="#cb5-84"></a><span class="co">#&gt; [1] 0.07184702</span></span>
<span id="cb5-85"><a href="#cb5-85"></a></span>
<span id="cb5-86"><a href="#cb5-86"></a><span class="co"># Plot</span></span>
<span id="cb5-87"><a href="#cb5-87"></a>x &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span>(dat<span class="op">$</span>y)</span>
<span id="cb5-88"><a href="#cb5-88"></a><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(x, dat<span class="op">$</span>y, <span class="dt">pch =</span> <span class="st">"."</span>, <span class="dt">cex =</span> <span class="dv">2</span>)</span>
<span id="cb5-89"><a href="#cb5-89"></a><span class="kw"><a href="https://rdrr.io/r/graphics/points.html">points</a></span>(<span class="kw"><a href="https://rdrr.io/r/utils/head.html">tail</a></span>(x, <span class="kw"><a href="https://rdrr.io/r/base/length.html">length</a></span>(test<span class="op">$</span>y)), test<span class="op">$</span>y, <span class="dt">col =</span> <span class="st">"red"</span>, <span class="dt">pch =</span> <span class="st">"."</span>, <span class="dt">cex =</span> <span class="dv">2</span>)</span>
<span id="cb5-90"><a href="#cb5-90"></a><span class="kw"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span>(<span class="kw"><a href="https://rdrr.io/r/utils/head.html">tail</a></span>(x, <span class="kw"><a href="https://rdrr.io/r/base/length.html">length</a></span>(test<span class="op">$</span>y)), test_pred)</span></code></pre></div>
<p><img src="splitTools_files/figure-html/unnamed-chunk-5-2.png" width="672"></p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">

        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#introduction">Introduction</a></li>
      <li><a href="#data-partitioning">Data partitioning</a></li>
      <li><a href="#cross-validation">Cross-validation</a></li>
      <li><a href="#repeated-cross-validation">Repeated cross-validation</a></li>
      <li><a href="#time-series-cross-validation-and-block-partitioning">Time-series cross-validation and block partitioning</a></li>
      </ul>
</div>
      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by Michael Mayer.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.4.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
